<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Chatbot con Redirección</title>
  <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>
</head>
<body>

 <df-messenger
  intent="WELCOME"
  chat-title="Nina"
  agent-id="820bd1d7-b43e-429d-a741-b1700de65e5a"
  language-code="es"
   chat-icon="https://cdn-icons-png.flaticon.com/512/4712/4712103.png"
   opened="true"
></df-messenger>

  <script>
  window.addEventListener('df-messenger-loaded', () => {
    const dfMessenger = document.querySelector('df-messenger');
    console.log("selector ", dfMessenger);

    const waitForMessages = () => {
      try {
        const chatElement = dfMessenger.shadowRoot.querySelector('df-messenger-chat');
        if (!chatElement) throw "Esperando df-messenger-chat...";

        const chatShadow = chatElement.shadowRoot;
        if (!chatShadow) throw "Esperando shadowRoot interno...";

        const messagesContainer = chatShadow.querySelector('.messages');
        if (!messagesContainer) throw "Esperando div .messages...";

        console.log("✅ .messages encontrado:", messagesContainer);

        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (
                node.nodeType === 1 &&
                node.classList.contains('message') &&
                node.innerText.startsWith('REDIRECT:')
              ) {
                const url = node.innerText.replace('REDIRECT:', '').trim();
                console.log("➡️ Redirigiendo a:", url);
                window.location.href = url;
              }
            });
          });
        });

        observer.observe(messagesContainer, { childList: true });

      } catch (e) {
        console.log("⏳", e);
        setTimeout(waitForMessages, 200); // vuelve a intentar
      }
    };

    waitForMessages();
  });
</script>

</body>
</html>
